<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <title>Radar Weather Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; }
        #mapid { height: 100%; width: 100%; background-color: #000; }
        .country-label, .state-label { background: transparent; color: white; text-shadow: 1px 1px 2px black; border: none; font-size: 12px; font-weight: bold; text-align: center; }
        #timestamp, #radar-legend { position: absolute; z-index: 1000; background: rgba(0,0,0,0.5); color: white; padding: 5px 10px; border-radius: 5px; font-family: sans-serif; font-size: 14px; }
        #timestamp { top: 10px; left: 10px; }
        #radar-legend { bottom: 10px; right: 10px; }
        .legend-item { display: flex; align-items: center; margin-bottom: 3px; }
        .legend-color { width: 20px; height: 20px; margin-right: 5px; border: 1px solid #fff; }
    </style>
</head>
<body>
    <div id="mapid"></div>
    <div id="timestamp"></div>
    <div id="radar-legend"></div>
    <script>
        const API_KEYS = {
            OWM: '06aac0fd4ba239a20d824ef89602f311',
            MAPBOX: 'pk.eyJ1IjoiaGFzdHl0dWJlIiwiYSI6ImNsa2hkZTh6bzAwazQzZHFyNmF5aTRsZGwifQ.5QJvYIHo0odZ5jCFApV7yw',
            WEATHER_COM: 'e1f10a1e78da46f5b10a1e78da96f525'
        };

        let map, radarLayers = {}, satelliteLayers = {}, apiData = {}, mapFrames = [];
        let infraSatLayers = [], infraSatTimestamps = [];
        let animationTimer = null, animationPosition = 0;
        let optionColorScheme = 4, optionSmoothData = 1, optionSnowColors = 1;
        let optionTileSize = 256;

        function initMap() {
            const urlParams = new URLSearchParams(window.location.search);
            const lat = urlParams.get('lat') || 6.4238;
            const lon = urlParams.get('lon') || -66.5897;
            const zoom = urlParams.get('zoom') || 7; // Ajuste de zoom

            map = L.map('mapid', { zoomControl: false }).setView([lat, lon], zoom);

            // Capa base de satélite de Esri
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            }).addTo(map);

            // La capa de etiquetas se ha eliminado según lo solicitado.

            // --- Añadir fronteras y nombres de ciudades ---
            map.createPane('labels');
            map.getPane('labels').style.zIndex = 650;
            map.getPane('labels').style.pointerEvents = 'none';

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                pane: 'labels'
            }).addTo(map);

            fetch('https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson')
                .then(response => response.json())
                .then(geojson => {
                    L.geoJSON(geojson, {
                        style: {
                            color: '#ff7800',
                            weight: 1.5,
                            fill: false,
                            opacity: 0.7
                        }
                    }).addTo(map);
                }).catch(e => console.error('Error fetching country borders:', e));

            // --- Añadir fronteras de estados de Venezuela ---
            fetch('https://raw.githubusercontent.com/codeforvenezuela/geojson-venezuela/master/venezuela_estados.geojson')
                .then(response => response.json())
                .then(geojson => {
                    L.geoJSON(geojson, {
                        style: {
                            color: '#0066cc',
                            weight: 1,
                            fill: false,
                            opacity: 0.8
                        }
                    }).addTo(map);
                }).catch(e => console.error('Error fetching Venezuela state borders:', e));

            loadRadarData();
            addInfraSatLayer();
            addCoverageLayer(); // Añadir la capa de cobertura
        }

        async function loadRadarData() {
            try {
                const response = await fetch(`https://api.rainviewer.com/public/weather-maps.json?t=${Date.now()}`);
                apiData = await response.json();
                mapFrames = [...apiData.radar.past, ...(apiData.radar.nowcast || [])].slice(-15);

                Object.values(radarLayers).forEach(layer => map.removeLayer(layer));
                Object.values(satelliteLayers).forEach(layer => map.removeLayer(layer));
                radarLayers = {};
                satelliteLayers = {};

                mapFrames.forEach(frame => {
                    radarLayers[frame.path] = L.tileLayer(`${apiData.host}${frame.path}/${optionTileSize}/{z}/{x}/{y}/${optionColorScheme}/${optionSmoothData}_${optionSnowColors}.png`, {
                        tileSize: optionTileSize, opacity: 0, zIndex: 200
                    }).addTo(map);
                    
                    const satFrame = apiData.satellite.infrared.find(f => f.time === frame.time);
                    if (satFrame) {
                        satelliteLayers[frame.path] = L.tileLayer(`${apiData.host}${satFrame.path}/${optionTileSize}/{z}/{x}/{y}/0/0_0.png`, {
                            tileSize: optionTileSize, opacity: 0, zIndex: 150
                        }).addTo(map);
                    }
                });
                
                startAnimation();
            } catch (e) {
                console.error("Error loading RainViewer data:", e);
            }
        }

        async function addInfraSatLayer() {
            try {
                const resp = await fetch('https://api.weather.com/v3/TileServer/series/productSet/PPAcore?filter=satrad&apiKey=' + API_KEYS.WEATHER_COM);
                const data = await resp.json();
                if (!data.seriesInfo || !data.seriesInfo.satrad) return;

                infraSatTimestamps = data.seriesInfo.satrad.series.sort((a, b) => a.ts - b.ts).slice(-15);
                
                infraSatLayers.forEach(layer => map.removeLayer(layer));
                infraSatLayers = infraSatTimestamps.map(tsObj =>
                    L.tileLayer(`https://api.weather.com/v3/TileServer/tile/satrad?ts=${tsObj.ts}&xyz={x}:{y}:{z}&apiKey=${API_KEYS.WEATHER_COM}`, {
                        tileSize: 256, opacity: 0, zIndex: 120
                    }).addTo(map)
                );
            } catch (e) {
                console.error("Error loading Weather.com infra-red satellite:", e);
            }
        }

        function showFrame(pos) {
            animationPosition = pos;
            const frame = mapFrames[pos];

            Object.values(radarLayers).forEach(l => l.setOpacity(0));
            Object.values(satelliteLayers).forEach(l => l.setOpacity(0));
            infraSatLayers.forEach(l => l.setOpacity(0));

            document.getElementById('timestamp').textContent = 'Hora: ' + new Date(frame.time * 1000).toLocaleTimeString();

            if (radarLayers[frame.path]) radarLayers[frame.path].setOpacity(0.7);
            if (satelliteLayers[frame.path]) satelliteLayers[frame.path].setOpacity(0.7);

            if (infraSatLayers.length > 0) {
                const satIdx = Math.floor((pos / (mapFrames.length - 1)) * (infraSatLayers.length - 1));
                if (infraSatLayers[satIdx]) infraSatLayers[satIdx].setOpacity(0.7);
            }
        }

        function startAnimation() {
            stopAnimation();
            if (!mapFrames.length) return;

            function nextFrame() {
                animationPosition = (animationPosition + 1) % mapFrames.length;
                showFrame(animationPosition);
                const speed = (animationPosition === mapFrames.length - 1) ? 1500 : 150;
                animationTimer = setTimeout(nextFrame, speed);
            }
            nextFrame();
        }

        function stopAnimation() {
            if (animationTimer) clearTimeout(animationTimer);
        }

        function addCoverageLayer() {
            L.tileLayer(
                `https://tilecache.rainviewer.com/v2/coverage/0/256/{z}/{x}/{y}/0/0_0.png`,
                { tileSize: 256, opacity: 0.3, zIndex: 60 }
            ).addTo(map);
        }

        function createRadarLegend() {
            const legendData = [
                { dbz: 70, color: '#f00505' }, { dbz: 60, color: '#ff5400' },
                { dbz: 50, color: '#ff9000' }, { dbz: 40, color: '#e7d800' },
                { dbz: 30, color: '#32cd32' }, { dbz: 20, color: '#00965a' },
                { dbz: 10, color: '#005ac8' }, { dbz: 0, color: '#96b4ff' }
            ];

            const legendContainer = document.getElementById('radar-legend');
            legendContainer.innerHTML = '<div style="font-weight:bold; margin-bottom:5px;">Intensidad (dBZ)</div>';

            legendData.forEach(item => {
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.innerHTML = `
                    <div class="legend-color" style="background-color: ${item.color};"></div>
                    <div>${item.dbz}</div>
                `;
                legendContainer.appendChild(legendItem);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            createRadarLegend();
        });
    </script>
</body>
</html>